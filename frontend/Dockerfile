# Usa una versiÃ³n de Node.js estable y compatible con Angular
FROM node:18-bullseye

# ğŸ“ Establecer directorio de trabajo
WORKDIR /app

# ğŸ”½ Copiar package.json y package-lock.json antes de instalar dependencias
COPY package.json package-lock.json ./

# ğŸ› ï¸ Instalar Angular CLI globalmente en el contenedor
RUN npm install -g @angular/cli@18.2.12

# ğŸ“¦ Instalar dependencias sin dependencias opcionales para evitar problemas en ARM64
RUN npm ci --omit=optional --legacy-peer-deps

# ğŸ—ï¸ Instalar Rollup de manera explÃ­cita (para evitar problemas en ARM64)
RUN npm install rollup --save-dev --force

# âš™ï¸ Forzar compatibilidad con arquitectura x64
RUN npm rebuild esbuild --platform=linux --arch=x64

# ğŸ”½ Copiar el cÃ³digo fuente despuÃ©s de instalar dependencias
COPY . .

# ğŸ”¨ Construir la aplicaciÃ³n en modo producciÃ³n
RUN npm run build --configuration=production

# ğŸŒ Instalar un servidor HTTP ligero para servir Angular
RUN npm install -g http-server

# ğŸŒ Exponer el puerto para servir la aplicaciÃ³n en producciÃ³n
EXPOSE 4200

# ğŸš€ Ejecutar el servidor en la carpeta correcta del build (dist)
CMD ["http-server", "dist/Spike", "-p", "4200", "--history-api-fallback"]
